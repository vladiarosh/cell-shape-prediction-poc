"""
Here I merge SMILES generated by with ChemSpider with variance filtered file,
and I also clean out rows where SMILES could not be generated
"""
import pandas as pd


def merge_smiles_with_filtered_data(smiles_file, filtered_file, output_file):
    compounds_df = pd.read_csv(smiles_file)
    filtered_df = pd.read_parquet(filtered_file)

    merged_df = filtered_df.merge(compounds_df[['Metadata_JCP2022', 'SMILES']], on='Metadata_JCP2022', how='left')
    cleaned_df = merged_df.dropna(subset=['SMILES'])

    columns_order = (['Metadata_JCP2022', 'SMILES'] +
                     [col for col in cleaned_df.columns if col not in ['Metadata_JCP2022', 'SMILES']])
    cleaned_df = cleaned_df[columns_order]

    cleaned_df.to_parquet(output_file, index=False)
    return cleaned_df
